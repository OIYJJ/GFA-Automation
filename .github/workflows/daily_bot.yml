name: GFA Marketing Bot (Lee's PC)

on:
  # 1. 스케줄 실행: 매일 한국 시간 05:30 (UTC 20:30)
  schedule:
    - cron: '30 20 * * *'
  
  # 2. 수동 실행: 테스트용 버튼 유지
  workflow_dispatch:

jobs:
  run-local-marketing-bot:
    runs-on: self-hosted
    
    steps:
      - name: 1. 자동화 시작 & 한글 설정
        shell: cmd
        run: |
          chcp 65001
          echo "🚀 [Auto] 05:30 정기 실행: GFA 마케팅 봇을 가동합니다..."

      - name: 2. 크롬 정리 (세션 보호 모드)
        shell: cmd
        run: |
          echo "🧹 실행 중인 크롬 프로세스를 정리합니다..."
          :: [중요] /F(강제종료) 옵션을 제거하여 쿠키 손상을 방지합니다.
          taskkill /IM chrome.exe /T 2>nul
          
          echo "✅ 프로세스 정리 신호 전송. 5초 대기..."
          ping 127.0.0.1 -n 6 > nul

      - name: 3. 크롬 디버깅 모드 실행
        shell: cmd
        run: |
          echo "🌐 크롬 브라우저를 엽니다 (로그인 정보 로드)..."
          :: start 명령어에 /MIN 옵션을 추가하여 작업 방해 최소화 (선택 사항)
          start "" "C:\Program Files\Google\Chrome\Application\chrome.exe" --remote-debugging-port=9222 --user-data-dir="C:\chrometemp" --no-sandbox --disable-gpu --disable-dev-shm-usage
          
          echo "⏳ 로그인 세션 로딩 및 페이지 안정화 (20초 대기)..."
          :: PC 성능에 따라 로딩 시간이 다를 수 있어 10초 -> 20초로 연장
          ping 127.0.0.1 -n 21 > nul
          
          echo "🔍 파이썬 수집 스크립트 실행..."
          :: 파이썬 인코딩 강제 설정
          set PYTHONIOENCODING=utf-8
          set PYTHONUTF8=1
          
          cd /d "C:\Users\82108\Desktop\업무자동화"
          python gfa_bot_final.py

      - name: 4. 구글 시트 업로드
        shell: cmd
        run: |
          echo "☁️ 구글 시트 업로드 실행..."
          set PYTHONIOENCODING=utf-8
          set PYTHONUTF8=1
          
          cd /d "C:\Users\82108\Desktop\업무자동화"
          python gfa_to_sheet.py

      - name: 5. 작업 완료 및 PC 종료 (성공 시에만)
        if: success()
        shell: cmd
        run: |
          echo "✅ 모든 작업이 성공적으로 완료되었습니다."
          echo "🛑 3분(180초) 뒤 PC가 종료됩니다. (작업 확인 시간 확보)"
          echo "취소하려면 실행창(Win+R)에 'shutdown -a'를 입력하세요."
          shutdown -s -f -t 180
