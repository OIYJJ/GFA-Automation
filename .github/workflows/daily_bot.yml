name: GFA Marketing Bot (Lee's PC)

on:
  schedule:
    - cron: '30 20 * * *' # 05:30 KST
    - cron: '0 4 * * *'   # 13:00 KST
    - cron: '20 6 * * *'  # 15:20 KST
  workflow_dispatch:
    inputs:
      force_main_run:
        description: "수동 실행 (체크 시 데이터 즉시 수집)"
        required: false
        type: boolean
        default: true

concurrency:
  group: gfa-marketing-bot-lee-pc
  cancel-in-progress: true

env:
  WORK_DIR: "C:\\Users\\82108\\Desktop\\업무자동화"

jobs:
  run-local-marketing-bot:
    runs-on: [self-hosted, windows]
    timeout-minutes: 15

    steps:
      - name: 1. 실행 모드 설정 (수집 vs 세션 연장)
        shell: cmd
        run: |
          chcp 65001
          if "${{ github.event.inputs.force_main_run }}"=="true" (
            echo MAIN_RUN=true>> "%GITHUB_ENV%"
          ) else if "${{ github.event.schedule }}"=="30 20 * * *" (
            echo MAIN_RUN=true>> "%GITHUB_ENV%"
          ) else (
            echo MAIN_RUN=false>> "%GITHUB_ENV%"
          )

      - name: 2. 크롬 프로세스 정리 (충돌 방지)
        shell: cmd
        run: |
          chcp 65001
          powershell -NoProfile -Command "Get-CimInstance Win32_Process | Where-Object { $_.Name -match 'chrome(driver)?\.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"

      - name: 3. 파이썬 실행 (GFA 데이터 수집)
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          chcp 65001
          set "PYTHONIOENCODING=utf-8"
          python gfa_bot_final.py

      - name: 4. 파이썬 실행 (구글 시트 업로드)
        if: env.MAIN_RUN == 'true'
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          chcp 65001
          set "PYTHONIOENCODING=utf-8"
          python gfa_to_sheet.py
