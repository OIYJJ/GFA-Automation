name: GFA Marketing Bot (Lee's PC)

on:
  schedule:
    - cron: '30 20 * * *' # 05:30 KST (ìƒˆë²½ ìˆ˜ì§‘)
    - cron: '0 4 * * *'   # 13:00 KST (ì ì‹¬ ì„¸ì…˜ ì—°ì¥)
    - cron: '20 6 * * *'  # 15:20 KST (ì˜¤í›„ ì„¸ì…˜ ì—°ì¥)
  workflow_dispatch:
    inputs:
      force_main_run:
        description: "ìˆ˜ë™ ì‹¤í–‰ ì‹œ ë°ì´í„° ìˆ˜ì§‘ ê°•ì œ ì—¬ë¶€ (true/false)"
        required: false
        default: "true"

concurrency:
  group: gfa-marketing-bot-lee-pc
  cancel-in-progress: true

env:
  WORK_DIR: "C:\\Users\\82108\\Desktop\\ì—…ë¬´ìë™í™”"
  PROFILE_PATH: "C:\\chrometemp"

jobs:
  run-local-marketing-bot:
    runs-on: [self-hosted, windows]
    timeout-minutes: 20

    steps:
      - name: 1. ì‹¤í–‰ ëª¨ë“œ ì„¤ì • (ìˆ˜ì§‘ vs ì„¸ì…˜ ì—°ì¥)
        shell: cmd
        run: |
          chcp 65001
          set "FORCE_MAIN=${{ github.event.inputs.force_main_run }}"
          set "SCHEDULE=${{ github.event.schedule }}"

          if /I "%FORCE_MAIN%"=="true" (
            echo ğŸŒ™ [ìˆ˜ë™-ê°•ì œ] MAIN_RUN=true
            echo MAIN_RUN=true>> "%GITHUB_ENV%"
          ) else if "%SCHEDULE%"=="30 20 * * *" (
            echo ğŸŒ™ [ìƒˆë²½ ëª¨ë“œ] ë©”ì¸ ìˆ˜ì§‘ + ì—…ë¡œë“œ í™œì„±í™”
            echo MAIN_RUN=true>> "%GITHUB_ENV%"
          ) else (
            echo â˜€ï¸ [ì—…ë¬´ ëª¨ë“œ] ì„¸ì…˜ ì—°ì¥ ëª¨ë“œ
            echo MAIN_RUN=false>> "%GITHUB_ENV%"
          )

      - name: 2. ì´ì „ í¬ë¡¬ ì°Œêº¼ê¸° ì •ë¦¬ ë° íŒì—… ë°©ì§€ íŒ¨ì¹˜ (BOM ì œê±° ë²„ì „)
        shell: cmd
        run: |
          chcp 65001
          echo ğŸ§¹ ë‚¨ì•„ìˆëŠ” ë´‡ ì „ìš© í¬ë¡¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤...
          powershell -NoProfile -Command "Get-CimInstance Win32_Process | Where-Object { $_.Name -match 'chrome(driver)?\.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"
          
          if exist "${{ env.PROFILE_PATH }}\SingletonLock" del /f /q "${{ env.PROFILE_PATH }}\SingletonLock"
          
          echo ğŸ› ï¸ í¬ë¡¬ 'ë¹„ì •ìƒ ì¢…ë£Œ' íŒì—… ë°©ì§€ (BOM ì—†ì´ ì•ˆì „í•˜ê²Œ ì €ì¥)...
          set "PREF_FILE=${{ env.PROFILE_PATH }}\Default\Preferences"
          if exist "%PREF_FILE%" (
            powershell -NoProfile -Command "$p='%PREF_FILE%'; $t=[System.IO.File]::ReadAllText($p); if($t -match 'exit_type\":\"Crashed'){ $t2=$t -replace 'exit_type\":\"Crashed','exit_type\":\"Normal'; $utf8NoBom = New-Object System.Text.UTF8Encoding $false; [System.IO.File]::WriteAllText($p, $t2, $utf8NoBom); echo 'âœ… íŒì—… ë°©ì§€ íŒ¨ì¹˜ ì™„ë£Œ' }"
          )

      - name: 3. GFA ë°ì´í„° ìˆ˜ì§‘ (íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ 1)
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          chcp 65001
          set "PYTHONIOENCODING=utf-8"
          python gfa_bot_final.py

      - name: 4. êµ¬ê¸€ ì‹œíŠ¸ ì—…ë¡œë“œ (íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ 2)
        if: env.MAIN_RUN == 'true'
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          chcp 65001
          set "PYTHONIOENCODING=utf-8"
          python gfa_to_sheet.py
