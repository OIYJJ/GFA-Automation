name: GFA Marketing Bot (Lee's PC)

on:
  schedule:
    # í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë§¤ì¼ ì•„ì¹¨ 05:30 ì‹¤í–‰ (UTC ê¸°ì¤€ 20:30)
    - cron: '30 20 * * *'
  workflow_dispatch:
    inputs:
      force_run:
        description: "ìˆ˜ë™ìœ¼ë¡œ ì¦‰ì‹œ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
        required: true
        type: boolean
        default: true

concurrency:
  group: gfa-marketing-bot-lee-pc
  cancel-in-progress: true

env:
  WORK_DIR: "C:\\Users\\82108\\Desktop\\ì—…ë¬´ìë™í™”"
  CHROME_PATH: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
  PROFILE_PATH: "C:\\chrometemp"
  DEBUG_PORT: "9222"

jobs:
  run-local-bot:
    runs-on: [self-hosted, windows]
    timeout-minutes: 30

    steps:
      - name: 1. ê¸°ì¡´ ë´‡ í¬ë¡¬ ë° ì°Œêº¼ê¸° ì™„ë²½ ì²­ì†Œ
        shell: cmd
        run: |
          chcp 65001
          echo ğŸ§¹ ì´ì „ ì‘ì—…ì˜ ì°Œêº¼ê¸°ë¥¼ ì²­ì†Œí•©ë‹ˆë‹¤...
          powershell -NoProfile -Command "Get-CimInstance Win32_Process | Where-Object { $_.Name -match 'chrome(driver)?\.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"
          if exist "${{ env.PROFILE_PATH }}\SingletonLock" del /f /q "${{ env.PROFILE_PATH }}\SingletonLock"
          ping 127.0.0.1 -n 3 > nul

      - name: 2. í¬ë¡¬ ì¼ê¸°ì¥ ì¡°ì‘ (ë¹„ì •ìƒ ì¢…ë£Œ íŒì—… ì›ì²œ ì°¨ë‹¨)
        shell: cmd
        run: |
          chcp 65001
          echo ğŸ› ï¸ í¬ë¡¬ì´ 'ì •ìƒ ì¢…ë£Œ'ë˜ì—ˆë‹¤ê³  ì†ì—¬ ë³µêµ¬ íŒì—…ì„ ë§‰ìŠµë‹ˆë‹¤...
          set "PREF_FILE=${{ env.PROFILE_PATH }}\Default\Preferences"
          if exist "%PREF_FILE%" (
            powershell -NoProfile -Command "$p='%PREF_FILE%'; $t=Get-Content $p -Raw; if($t -match 'exit_type\":\"Crashed'){ $t2=$t -replace 'exit_type\":\"Crashed','exit_type\":\"Normal'; Set-Content $p $t2 -Encoding UTF8; echo 'âœ… íŒì—… ì°¨ë‹¨ íŒ¨ì¹˜ ì™„ë£Œ' }"
          )

      - name: 3. ë´‡ ì „ìš© í¬ë¡¬ ë¸Œë¼ìš°ì € ì•ˆì „ ì‹¤í–‰
        shell: cmd
        run: |
          chcp 65001
          echo ğŸŒ í†µì‹  ì£¼ì†Œë¥¼ 127.0.0.1ë¡œ ê³ ì •í•˜ì—¬ í¬ë¡¬ì„ ì¼­ë‹ˆë‹¤...
          start "" "${{ env.CHROME_PATH }}" ^
            --remote-allow-origins=* ^
            --remote-debugging-port=${{ env.DEBUG_PORT }} ^
            --remote-debugging-address=127.0.0.1 ^
            --user-data-dir="${{ env.PROFILE_PATH }}" ^
            --disable-gpu ^
            --disable-dev-shm-usage ^
            --disable-session-crashed-bubble ^
            --hide-crash-restore-bubble ^
            --no-first-run ^
            --window-size=1920,1080

          echo â³ ë¸Œë¼ìš°ì € ì¤€ë¹„ ëŒ€ê¸° ë° í¬íŠ¸ ê²€ì‚¬ (ìµœëŒ€ 30ì´ˆ)...
          set /a TRY=0
          :RETRY_PORT
          set /a TRY+=1
          powershell -NoProfile -Command "if ((Test-NetConnection 127.0.0.1 -Port ${{ env.DEBUG_PORT }}).TcpTestSucceeded) { exit 0 } else { exit 1 }"
          if %ERRORLEVEL%==0 (echo âœ… í¬íŠ¸ %DEBUG_PORT% í™•ì¸ ì™„ë£Œ! && goto :PORT_OK)
          if %TRY% GEQ 6 (echo âŒ í¬íŠ¸ ì‘ë‹µ ì—†ìŒ && exit /b 1)
          ping 127.0.0.1 -n 6 > nul
          goto :RETRY_PORT
          :PORT_OK

      - name: 4. íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ë°ì´í„° ìˆ˜ì§‘)
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          chcp 65001
          set "PYTHONIOENCODING=utf-8"
          python gfa_bot_final.py

      - name: 5. íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (êµ¬ê¸€ ì‹œíŠ¸ ì—…ë¡œë“œ)
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          chcp 65001
          set "PYTHONIOENCODING=utf-8"
          python gfa_to_sheet.py

      - name: 6. ëª¨ë“  ì‘ì—… ì™„ë£Œ í›„ ì•ˆì „ ì¢…ë£Œ
        if: always()
        shell: cmd
        run: |
          chcp 65001
          echo ğŸŒ™ ì‘ì—…ì´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë´‡ ì „ìš© í¬ë¡¬ì„ ë‹«ìŠµë‹ˆë‹¤.
          powershell -NoProfile -Command "Get-CimInstance Win32_Process | Where-Object { $_.Name -match 'chrome(driver)?\.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"
