name: GFA Marketing Bot (Lee's PC)

on:
  schedule:
    # 1. 메인 실행 (새벽 05:30 KST)
    - cron: '30 20 * * *'
    # 2. 세션 연장 1 (오후 13:00 KST)
    - cron: '0 4 * * *'
    # 3. 세션 연장 2 (오후 15:20 KST)
    - cron: '20 6 * * *'
  
  workflow_dispatch:

env:
  WORK_DIR: "C:\\Users\\82108\\Desktop\\업무자동화"
  CHROME_PATH: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
  PROFILE_PATH: "C:\\chrometemp"

jobs:
  run-local-marketing-bot:
    runs-on: self-hosted
    timeout-minutes: 10
    
    steps:
      - name: 1. 시간대 확인 및 모드 설정
        shell: cmd
        run: |
          chcp 65001
          echo "🚀 현재 시간을 확인하여 실행 모드를 결정합니다..."
          
          for /f %%H in ('powershell -command "(Get-Date).Hour"') do set CURRENT_HOUR=%%H
          echo 현재 시간: %CURRENT_HOUR%시
          
          if "%CURRENT_HOUR%"=="5" (
            echo "🌙 [새벽 모드] 메인 수집 작업입니다."
            echo MAIN_RUN=true>> %GITHUB_ENV%
          ) else (
            echo "☀️ [업무 모드] 세션 연장 작업입니다."
            echo MAIN_RUN=false>> %GITHUB_ENV%
          )

      - name: 2. [새벽 전용] 전체 크롬 정리
        if: env.MAIN_RUN == 'true'
        shell: cmd
        run: |
          echo "🧹 [새벽] PC 클린업을 위해 모든 크롬을 정리합니다..."
          taskkill /IM chrome.exe /T 2>nul
          ping 127.0.0.1 -n 4 > nul

      - name: 3. 크롬 봇 브라우저 실행 (핀셋 정리 포함)
        shell: cmd
        run: |
          echo "🌐 봇 전용 크롬 브라우저를 실행합니다..."
          
          :: [핵심 수정] 업무용 크롬은 살리고, 'chrometemp' 프로필을 쓰는 봇 크롬만 골라서 죽입니다.
          :: 이 과정이 없으면 '좀비 프로세스' 때문에 포트 연결 에러가 발생합니다.
          echo "💉 봇 전용 좀비 프로세스 제거 중..."
          powershell -command "Get-CimInstance Win32_Process | Where-Object { $_.Name -eq 'chrome.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"
          
          echo "♻️ 프로세스 정리 완료. 브라우저 재시작..."
          ping 127.0.0.1 -n 3 > nul
          
          start "" "${{ env.CHROME_PATH }}" --remote-debugging-port=9222 --user-data-dir="${{ env.PROFILE_PATH }}" --no-sandbox --disable-gpu --disable-dev-shm-usage --disable-session-crashed-bubble --disable-infobars --no-first-run --no-default-browser-check --window-size=1920,1080
          
          echo "⏳ 브라우저 연결 대기 (15초)..."
          ping 127.0.0.1 -n 16 > nul

      - name: 4. 파이썬 스크립트 실행
        shell: cmd
        run: |
          echo "🔍 스크립트 실행..."
          set PYTHONIOENCODING=utf-8
          set PYTHONUTF8=1
          
          cd /d "${{ env.WORK_DIR }}"
          python gfa_bot_final.py

      - name: 5. [새벽 전용] 구글 시트 업로드
        if: env.MAIN_RUN == 'true'
        shell: cmd
        run: |
          echo "☁️ [새벽] 데이터 업로드..."
          set PYTHONIOENCODING=utf-8
          set PYTHONUTF8=1
          
          cd /d "${{ env.WORK_DIR }}"
          python gfa_to_sheet.py

      - name: 6. 작업 완료 처리
        if: always()
        shell: cmd
        run: |
          if "%MAIN_RUN%"=="true" (
             echo "🌙 [새벽] 작업 완료. 봇 브라우저 종료 및 PC 끄기"
             taskkill /IM chrome.exe /T 2>nul
             shutdown -s -f -t 180
          ) else (
             echo "☀️ [업무] 세션 연장 완료. 크롬 창을 유지합니다."
          )
