name: GFA Marketing Bot (Lee's PC)

on:
  schedule:
    - cron: '30 20 * * *' # 05:30 (새벽 메인)
    - cron: '0 4 * * *'   # 13:00 (점심 연장)
    - cron: '20 6 * * *'  # 15:20 (오후 연장)
  workflow_dispatch:

env:
  WORK_DIR: "C:\\Users\\82108\\Desktop\\업무자동화"
  CHROME_PATH: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
  PROFILE_PATH: "C:\\chrometemp"

jobs:
  run-local-marketing-bot:
    runs-on: self-hosted
    timeout-minutes: 10
    
    steps:
      - name: 1. 시간대 확인 및 모드 설정
        shell: cmd
        run: |
          chcp 65001
          for /f %%H in ('powershell -command "(Get-Date).Hour"') do set CURRENT_HOUR=%%H
          echo 현재 시간: %CURRENT_HOUR%시
          
          :: [추가] 사용자가 'Run workflow' 버튼을 직접 누른 경우 무조건 메인 작업(수집) 강제 실행
          if "${{ github.event_name }}"=="workflow_dispatch" (
            echo "⚡ [수동 모드] 메인 수집 강제 실행"
            echo MAIN_RUN=true>> %GITHUB_ENV%
            exit /b 0
          )
          
          if "%CURRENT_HOUR%"=="5" (
            echo "🌙 [새벽 모드] 메인 수집 작업"
            echo MAIN_RUN=true>> %GITHUB_ENV%
          ) else (
            echo "☀️ [업무 모드] 세션 연장 작업"
            echo MAIN_RUN=false>> %GITHUB_ENV%
          )

      - name: 2. [새벽 전용] 전체 크롬 정리
        if: env.MAIN_RUN == 'true'
        shell: cmd
        run: |
          echo "🧹 [새벽] 모든 크롬 프로세스 강제 정리..."
          taskkill /F /IM chrome.exe /T 2>nul
          ping 127.0.0.1 -n 4 > nul

      - name: 3. 크롬 봇 브라우저 실행 (안정성 강화 및 복구 팝업 원천 차단)
        shell: cmd
        run: |
          echo "💉 [업무모드] 좀비 프로세스 방지 (chrometemp만 종료)..."
          powershell -command "Get-CimInstance Win32_Process | Where-Object { $_.Name -eq 'chrome.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"
          ping 127.0.0.1 -n 3 > nul
          
          echo "🔓 프로필 잠금 파일(SingletonLock) 삭제 중..."
          if exist "${{ env.PROFILE_PATH }}\SingletonLock" del /f /q "${{ env.PROFILE_PATH }}\SingletonLock"
          
          echo "🛠️ 크롬 일기장 조작 중 (비정상 종료 팝업 방지)..."
          :: 크롬 설정 파일에서 Crashed(비정상 종료) 기록을 Normal(정상 종료)로 텍스트 치환합니다.
          if exist "${{ env.PROFILE_PATH }}\Default\Preferences" (
            powershell -command "(Get-Content '${{ env.PROFILE_PATH }}\Default\Preferences' -Raw) -replace '\"exit_type\":\"Crashed\"', '\"exit_type\":\"Normal\"' | Set-Content '${{ env.PROFILE_PATH }}\Default\Preferences'"
          )
          
          echo "🌐 봇 브라우저 실행..."
          :: --remote-allow-origins=* 옵션 추가로 파이썬 접속 차단 방지
          :: --hide-crash-restore-bubble 옵션 추가로 팝업 강제 숨김
          start "" "${{ env.CHROME_PATH }}" --remote-allow-origins=* --remote-debugging-port=9222 --user-data-dir="${{ env.PROFILE_PATH }}" --disable-gpu --disable-dev-shm-usage --disable-session-crashed-bubble --hide-crash-restore-bubble --disable-infobars --no-first-run --no-default-browser-check --window-size=1920,1080
          
          echo "⏳ 브라우저 완전 로딩 대기 (30초)..."
          ping 127.0.0.1 -n 31 > nul

          echo "🔍 포트 9222 활성화 상태 확인:"
          netstat -ano | findstr 9222

      - name: 4. 파이썬 스크립트 실행
        shell: cmd
        run: |
          set PYTHONIOENCODING=utf-8
          set PYTHONUTF8=1
          cd /d "${{ env.WORK_DIR }}"
          python gfa_bot_final.py

      - name: 5. [새벽 전용] 구글 시트 업로드
        if: env.MAIN_RUN == 'true'
        shell: cmd
        run: |
          set PYTHONIOENCODING=utf-8
          set PYTHONUTF8=1
          cd /d "${{ env.WORK_DIR }}"
          python gfa_to_sheet.py

      - name: 6. 작업 완료 처리
        if: always()
        shell: cmd
        run: |
          if "%MAIN_RUN%"=="true" (
             echo "🌙 [새벽] 작업 완료. 전체 종료."
             taskkill /F /IM chrome.exe /T 2>nul
             :: 안전을 위해 테스트 중에는 PC 자동 종료 명령어를 비활성화(주석 처리) 해두었습니다.
             :: 실제 운영 시 아래 줄의 :: 를 지워주시면 됩니다.
             :: shutdown -s -f -t 180
          ) else (
             echo "☀️ [업무] 작업 완료. 세션 연장 성공."
          )
