name: GFA Marketing Bot (Lee's PC)

on:
  schedule:
    # 1. 메인 실행 (새벽 05:30 KST) -> UTC 20:30
    - cron: '30 20 * * *'
    # 2. 세션 연장 1 (오후 13:00 KST) -> UTC 04:00
    - cron: '0 4 * * *'
    # 3. 세션 연장 2 (오후 15:20 KST) -> UTC 06:20
    - cron: '20 6 * * *'
  
  workflow_dispatch:

env:
  WORK_DIR: "C:\\Users\\82108\\Desktop\\업무자동화"
  CHROME_PATH: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
  PROFILE_PATH: "C:\\chrometemp"

jobs:
  run-local-marketing-bot:
    runs-on: self-hosted
    timeout-minutes: 10
    
    steps:
      - name: 1. 시간대 확인 및 모드 설정
        shell: cmd
        run: |
          chcp 65001
          echo "🚀 현재 시간을 확인하여 실행 모드를 결정합니다..."
          
          :: PowerShell로 현재 시간(Hour) 추출
          for /f %%H in ('powershell -command "(Get-Date).Hour"') do set CURRENT_HOUR=%%H
          echo 현재 시간: %CURRENT_HOUR%시
          
          :: 05시(새벽)일 때만 MAIN_RUN=true 설정
          if "%CURRENT_HOUR%"=="5" (
            echo "🌙 [새벽 모드] 메인 수집 작업입니다."
            echo MAIN_RUN=true>> %GITHUB_ENV%
          ) else (
            echo "☀️ [업무 모드] 세션 연장(새로고침) 작업입니다. 크롬을 끄지 않습니다."
            echo MAIN_RUN=false>> %GITHUB_ENV%
          )

      - name: 2. [새벽 전용] 크롬 정리
        if: env.MAIN_RUN == 'true'
        shell: cmd
        run: |
          echo "🧹 [새벽] 깨끗한 시작을 위해 기존 크롬을 안전하게 정리합니다..."
          :: /F 옵션 제거: 쿠키 손상 방지 (로그인 유지 핵심)
          taskkill /IM chrome.exe /T 2>nul
          ping 127.0.0.1 -n 4 > nul

      - name: 3. 크롬 봇 브라우저 실행
        shell: cmd
        run: |
          echo "🌐 봇 전용 크롬 브라우저를 실행합니다..."
          :: 이미 켜져 있다면(13시, 15시) 이 명령어는 기존 창을 활성화하기만 합니다. (재실행 X)
          start "" "${{ env.CHROME_PATH }}" --remote-debugging-port=9222 --user-data-dir="${{ env.PROFILE_PATH }}" --no-sandbox --disable-gpu --disable-dev-shm-usage --disable-session-crashed-bubble --disable-infobars --no-first-run --no-default-browser-check --window-size=1920,1080
          
          echo "⏳ 브라우저 연결 대기 (15초)..."
          ping 127.0.0.1 -n 16 > nul

      - name: 4. 파이썬 스크립트 실행
        shell: cmd
        run: |
          echo "🔍 스크립트 실행..."
          set PYTHONIOENCODING=utf-8
          set PYTHONUTF8=1
          
          cd /d "${{ env.WORK_DIR }}"
          python gfa_bot_final.py

      - name: 5. [새벽 전용] 구글 시트 업로드
        if: env.MAIN_RUN == 'true'
        shell: cmd
        run: |
          echo "☁️ [새벽] 수집된 데이터를 구글 시트에 업로드합니다..."
          set PYTHONIOENCODING=utf-8
          set PYTHONUTF8=1
          
          cd /d "${{ env.WORK_DIR }}"
          python gfa_to_sheet.py

      - name: 6. 작업 완료 처리
        if: always()
        shell: cmd
        run: |
          if "%MAIN_RUN%"=="true" (
             echo "🌙 [새벽] 작업 완료. 봇 브라우저를 닫고 PC를 종료합니다."
             :: 새벽에는 확실한 정리를 위해 크롬 종료
             taskkill /IM chrome.exe /T 2>nul
             
             echo "🛑 3분 뒤 PC가 종료됩니다..."
             shutdown -s -f -t 180
          ) else (
             echo "☀️ [업무] 세션 연장 완료. 현재 열려있는 크롬 창을 닫지 않고 유지합니다."
             echo "    (PC도 끄지 않습니다)"
          )
