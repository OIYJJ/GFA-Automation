name: GFA Marketing Bot (Lee's PC)

on:
  schedule:
    - cron: '30 20 * * *' # 05:30 (ìƒˆë²½ ë©”ì¸)
    - cron: '0 4 * * *'   # 13:00 (ì ì‹¬ ì—°ìž¥)
    - cron: '20 6 * * *'  # 15:20 (ì˜¤í›„ ì—°ìž¥)
  workflow_dispatch:

env:
  WORK_DIR: "C:\\Users\\82108\\Desktop\\ì—…ë¬´ìžë™í™”"
  CHROME_PATH: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
  PROFILE_PATH: "C:\\chrometemp"

jobs:
  run-local-marketing-bot:
    runs-on: self-hosted
    timeout-minutes: 10
    
    steps:
      - name: 1. ì‹œê°„ëŒ€ í™•ì¸ ë° ëª¨ë“œ ì„¤ì •
        shell: cmd
        run: |
          chcp 65001
          for /f %%H in ('powershell -command "(Get-Date).Hour"') do set CURRENT_HOUR=%%H
          echo í˜„ìž¬ ì‹œê°„: %CURRENT_HOUR%ì‹œ
          
          if "${{ github.event_name }}"=="workflow_dispatch" (
            echo "âš¡ [ìˆ˜ë™ ëª¨ë“œ] ë©”ì¸ ìˆ˜ì§‘ ê°•ì œ ì‹¤í–‰"
            echo MAIN_RUN=true>> %GITHUB_ENV%
          ) else if "%CURRENT_HOUR%"=="5" (
            echo "ðŸŒ™ [ìƒˆë²½ ëª¨ë“œ] ë©”ì¸ ìˆ˜ì§‘ ìž‘ì—…"
            echo MAIN_RUN=true>> %GITHUB_ENV%
          ) else (
            echo "â˜€ï¸ [ì—…ë¬´ ëª¨ë“œ] ì„¸ì…˜ ì—°ìž¥ ìž‘ì—…"
            echo MAIN_RUN=false>> %GITHUB_ENV%
          )

      - name: 2. [ìƒˆë²½/ìˆ˜ë™ ì „ìš©] ì „ì²´ í¬ë¡¬ ì •ë¦¬
        if: env.MAIN_RUN == 'true'
        shell: cmd
        run: |
          taskkill /F /IM chrome.exe /T 2>nul
          ping 127.0.0.1 -n 4 > nul

      - name: 3. í¬ë¡¬ ë´‡ ë¸Œë¼ìš°ì € ì‹¤í–‰ (í†µì‹  ì•ˆì •ì„± ê·¹ëŒ€í™”)
        shell: cmd
        run: |
          echo "ðŸ’‰ ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
          powershell -command "Get-CimInstance Win32_Process | Where-Object { $_.Name -eq 'chrome.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"
          if exist "${{ env.PROFILE_PATH }}\SingletonLock" del /f /q "${{ env.PROFILE_PATH }}\SingletonLock"
          
          echo "ðŸ› ï¸ ë³µêµ¬ íŒì—… ë°©ì§€ ì¡°ìž‘..."
          if exist "${{ env.PROFILE_PATH }}\Default\Preferences" (
            powershell -command "(Get-Content '${{ env.PROFILE_PATH }}\Default\Preferences' -Raw) -replace '\"exit_type\":\"Crashed\"', '\"exit_type\":\"Normal\"' | Set-Content '${{ env.PROFILE_PATH }}\Default\Preferences'"
          )
          
          echo "ðŸŒ ë´‡ ë¸Œë¼ìš°ì € ì‹¤í–‰..."
          :: --remote-debugging-address=0.0.0.0 ë¥¼ ì¶”ê°€í•˜ì—¬ ë¡œì»¬ ë£¨í”„ë°± í†µì‹ ì„ ê°•í™”í•¨
          start "" "${{ env.CHROME_PATH }}" --remote-allow-origins=* --remote-debugging-port=9222 --remote-debugging-address=0.0.0.0 --user-data-dir="${{ env.PROFILE_PATH }}" --disable-gpu --disable-dev-shm-usage --disable-session-crashed-bubble --hide-crash-restore-bubble --no-first-run --no-default-browser-check --window-size=1920,1080
          
          echo "â³ ë¸Œë¼ìš°ì € ì™„ì „ ë¡œë”© ëŒ€ê¸° (40ì´ˆ)..."
          ping 127.0.0.1 -n 41 > nul
          netstat -ano | findstr 9222

      - name: 4. íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          set PYTHONIOENCODING=utf-8
          set PYTHONUTF8=1
          python gfa_bot_final.py

      - name: 5. [ìƒˆë²½/ìˆ˜ë™ ì „ìš©] êµ¬ê¸€ ì‹œíŠ¸ ì—…ë¡œë“œ
        if: env.MAIN_RUN == 'true'
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          set PYTHONIOENCODING=utf-8
          python gfa_to_sheet.py

      - name: 6. ìž‘ì—… ì™„ë£Œ ì²˜ë¦¬
        if: always()
        shell: cmd
        run: |
          if "%MAIN_RUN%"=="true" (
             taskkill /F /IM chrome.exe /T 2>nul
          )
