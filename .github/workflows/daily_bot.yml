name: GFA Marketing Bot (Lee's PC)

on:
  schedule:
    - cron: '30 20 * * *' # 05:30 KST (ìƒˆë²½ ë©”ì¸)  [GitHub cronì€ UTC ê¸°ì¤€]
    - cron: '0 4 * * *'   # 13:00 KST (ì ì‹¬ ì—°ì¥)
    - cron: '20 6 * * *'  # 15:20 KST (ì˜¤í›„ ì—°ì¥)
  workflow_dispatch:
    inputs:
      force_main_run:
        description: "ìˆ˜ë™ ì‹¤í–‰ ì‹œ MAIN_RUN ê°•ì œ(true/false). ë¹„ìš°ë©´ schedule ê¸°ì¤€ìœ¼ë¡œ ìë™ ê²°ì •"
        required: false
        default: ""

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ (ì´ì „ ì‹¤í–‰ì´ ë‚¨ì•„ìˆìœ¼ë©´ íì‰/ì·¨ì†Œë¡œ ì¶©ëŒ ë°©ì§€)
concurrency:
  group: gfa-marketing-bot-lee-pc
  cancel-in-progress: true

env:
  WORK_DIR: "C:\\Users\\82108\\Desktop\\ì—…ë¬´ìë™í™”"
  CHROME_PATH: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
  PROFILE_PATH: "C:\\chrometemp"
  DEBUG_PORT: "9222"

jobs:
  run-local-marketing-bot:
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      - name: 1. íŠ¸ë¦¬ê±° ê¸°ì¤€ ëª¨ë“œ ì„¤ì • (schedule / workflow_dispatch)
        shell: cmd
        run: |
          chcp 65001

          set "FORCE_MAIN=${{ github.event.inputs.force_main_run }}"
          set "SCHEDULE=${{ github.event.schedule }}"

          echo Trigger schedule: %SCHEDULE%
          echo Force main input: %FORCE_MAIN%

          REM 1) ìˆ˜ë™ ì‹¤í–‰ì—ì„œ force_main_runì´ ì§€ì •ë˜ë©´ ê·¸ ê°’ì„ ìš°ì„  ì ìš©
          if not "%FORCE_MAIN%"=="" (
            if /I "%FORCE_MAIN%"=="true" (
              echo ğŸŒ™ [ìˆ˜ë™-ê°•ì œ] MAIN_RUN=true
              echo MAIN_RUN=true>> "%GITHUB_ENV%"
              goto :EOF
            )
            if /I "%FORCE_MAIN%"=="false" (
              echo â˜€ï¸ [ìˆ˜ë™-ê°•ì œ] MAIN_RUN=false
              echo MAIN_RUN=false>> "%GITHUB_ENV%"
              goto :EOF
            )
            echo âš ï¸ force_main_run ê°’ì´ true/falseê°€ ì•„ë‹™ë‹ˆë‹¤. ìë™ íŒë³„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.
          )

          REM 2) schedule ê¸°ë°˜ ìë™ íŒë³„ (UTC cron ë¬¸ìì—´ë¡œ êµ¬ë¶„)
          REM    - '30 20 * * *' => KST 05:30 ë©”ì¸
          if "%SCHEDULE%"=="30 20 * * *" (
            echo ğŸŒ™ [ìƒˆë²½ ëª¨ë“œ] ë©”ì¸ ìˆ˜ì§‘ + ì—…ë¡œë“œ
            echo MAIN_RUN=true>> "%GITHUB_ENV%"
          ) else (
            echo â˜€ï¸ [ì—…ë¬´ ëª¨ë“œ] ì„¸ì…˜ ì—°ì¥(ìˆ˜ì§‘ë§Œ ìˆ˜í–‰)
            echo MAIN_RUN=false>> "%GITHUB_ENV%"
          )

      - name: 2. í¬ë¡¬/í”„ë¡œí•„ ì •ë¦¬ (chrometemp ëŒ€ìƒë§Œ)
        shell: cmd
        run: |
          chcp 65001
          echo ğŸ§¹ chrometemp ê¸°ë°˜ chrome.exeë§Œ ì¢…ë£Œí•©ë‹ˆë‹¤...

          powershell -command "Get-CimInstance Win32_Process | Where-Object { $_.Name -eq 'chrome.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"
          ping 127.0.0.1 -n 3 > nul

          echo ğŸ”“ í”„ë¡œí•„ ì ê¸ˆ íŒŒì¼(Singleton*) ì •ë¦¬ ì¤‘...
          if exist "${{ env.PROFILE_PATH }}\SingletonLock" del /f /q "${{ env.PROFILE_PATH }}\SingletonLock"
          if exist "${{ env.PROFILE_PATH }}\SingletonCookie" del /f /q "${{ env.PROFILE_PATH }}\SingletonCookie"
          if exist "${{ env.PROFILE_PATH }}\SingletonSocket" del /f /q "${{ env.PROFILE_PATH }}\SingletonSocket"

      - name: 3. í¬ë¡¬ ë´‡ ë¸Œë¼ìš°ì € ì‹¤í–‰ ë° í¬íŠ¸ ê²€ì¦
        shell: cmd
        run: |
          chcp 65001

          echo ğŸŒ ë´‡ ë¸Œë¼ìš°ì € ì‹¤í–‰...
          start "" "${{ env.CHROME_PATH }}" ^
            --remote-debugging-port=${{ env.DEBUG_PORT }} ^
            --user-data-dir="${{ env.PROFILE_PATH }}" ^
            --disable-gpu ^
            --disable-dev-shm-usage ^
            --disable-session-crashed-bubble ^
            --disable-infobars ^
            --no-first-run ^
            --no-default-browser-check ^
            --window-size=1920,1080

          echo â³ ë¸Œë¼ìš°ì € ë¡œë”© ëŒ€ê¸° (30ì´ˆ)...
          ping 127.0.0.1 -n 31 > nul

          echo ğŸ” í¬íŠ¸ ${{ env.DEBUG_PORT }} í™œì„±í™” í™•ì¸...
          powershell -command "if (-not (Test-NetConnection 127.0.0.1 -Port $env:DEBUG_PORT).TcpTestSucceeded) { Write-Host 'âŒ Port not open'; exit 1 } else { Write-Host 'âœ… Port open' }"

          echo (ì°¸ê³ ) netstat ì¶œë ¥:
          netstat -ano | findstr ${{ env.DEBUG_PORT }}

      - name: 4. íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (GFA ìˆ˜ì§‘)
        shell: cmd
        run: |
          chcp 65001
          set PYTHONIOENCODING=utf-8
          set PYTHONUTF8=1
          cd /d "${{ env.WORK_DIR }}"
          echo â–¶ MAIN_RUN=%MAIN_RUN%
          python gfa_bot_final.py

      - name: 5. [ìƒˆë²½ ì „ìš©] êµ¬ê¸€ ì‹œíŠ¸ ì—…ë¡œë“œ
        if: env.MAIN_RUN == 'true'
        shell: cmd
        run: |
          chcp 65001
          set PYTHONIOENCODING=utf-8
          set PYTHONUTF8=1
          cd /d "${{ env.WORK_DIR }}"
          python gfa_to_sheet.py

      - name: 6. ì‘ì—… ì™„ë£Œ ì²˜ë¦¬ (í•­ìƒ ì‹¤í–‰)
        if: always()
        shell: cmd
        run: |
          chcp 65001
          if "%MAIN_RUN%"=="true" (
            echo ğŸŒ™ [ìƒˆë²½] ì‘ì—… ì™„ë£Œ. chrometemp chrome ì¢…ë£Œ.
            powershell -command "Get-CimInstance Win32_Process | Where-Object { $_.Name -eq 'chrome.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"
          ) else (
            echo â˜€ï¸ [ì—…ë¬´] ì‘ì—… ì™„ë£Œ. ì„¸ì…˜ ì—°ì¥ ì„±ê³µ(ë¸Œë¼ìš°ì € ìœ ì§€).
          )
