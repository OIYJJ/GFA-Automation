name: GFA Marketing Bot (Lee's PC)

on:
  schedule:
    - cron: '30 20 * * *' # 05:30 (새벽 메인)
    - cron: '0 4 * * *'   # 13:00 (점심 연장)
    - cron: '20 6 * * *'  # 15:20 (오후 연장)
  workflow_dispatch:

env:
  WORK_DIR: "C:\\Users\\82108\\Desktop\\업무자동화"
  CHROME_PATH: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
  PROFILE_PATH: "C:\\chrometemp"

jobs:
  run-local-marketing-bot:
    runs-on: self-hosted
    timeout-minutes: 10
    
    steps:
      - name: 1. 시간대 확인 및 모드 설정
        shell: cmd
        run: |
          chcp 65001
          for /f %%H in ('powershell -command "(Get-Date).Hour"') do set CURRENT_HOUR=%%H
          echo 현재 시간: %CURRENT_HOUR%시
          
          if "${{ github.event_name }}"=="workflow_dispatch" (
            echo "⚡ [수동 모드] 메인 수집 강제 실행"
            echo MAIN_RUN=true>> %GITHUB_ENV%
          ) else if "%CURRENT_HOUR%"=="5" (
            echo "🌙 [새벽 모드] 메인 수집 작업"
            echo MAIN_RUN=true>> %GITHUB_ENV%
          ) else (
            echo "☀️ [업무 모드] 세션 연장 작업"
            echo MAIN_RUN=false>> %GITHUB_ENV%
          )

      - name: 2. 크롬 정리
        shell: cmd
        run: |
          taskkill /F /IM chrome.exe /T 2>nul
          ping 127.0.0.1 -n 4 > nul

      - name: 3. 크롬 브라우저 실행 (보안 옵션 강화)
        shell: cmd
        run: |
          echo "🛠️ 복구 팝업 방지 세팅..."
          if exist "${{ env.PROFILE_PATH }}\Default\Preferences" (
            powershell -command "(Get-Content '${{ env.PROFILE_PATH }}\Default\Preferences' -Raw) -replace '\"exit_type\":\"Crashed\"', '\"exit_type\":\"Normal\"' | Set-Content '${{ env.PROFILE_PATH }}\Default\Preferences'"
          )
          
          echo "🌐 브라우저 실행..."
          :: --remote-debugging-address=127.0.0.1 를 명시하여 통신 경로 고정
          start "" "${{ env.CHROME_PATH }}" --remote-allow-origins=* --remote-debugging-port=9222 --remote-debugging-address=127.0.0.1 --user-data-dir="${{ env.PROFILE_PATH }}" --disable-gpu --disable-dev-shm-usage --no-first-run --window-size=1920,1080
          
          echo "⏳ 로딩 대기 (40초)..."
          ping 127.0.0.1 -n 41 > nul
          netstat -ano | findstr 9222

      - name: 4. 파이썬 스크립트 실행
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          set PYTHONIOENCODING=utf-8
          python gfa_bot_final.py

      - name: 5. 구글 시트 업로드
        if: env.MAIN_RUN == 'true'
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: python gfa_to_sheet.py

      - name: 6. 작업 완료 처리
        if: always()
        shell: cmd
        run: |
          :: env.MAIN_RUN 변수 확인 방식을 더 안전하게 변경 (exit code 128 방지)
          if "%MAIN_RUN%"=="true" (
             echo "🌙 새벽 작업 완료. 크롬 종료."
             taskkill /F /IM chrome.exe /T 2>nul
          ) else (
             echo "☀️ 업무 연장 완료."
          )
