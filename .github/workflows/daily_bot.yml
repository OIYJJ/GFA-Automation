name: GFA Daily Update (Lee PC)

on:
  schedule:
    - cron: '30 20 * * *' # 05:30 KST (UTC+9)
  workflow_dispatch:

concurrency:
  group: gfa-daily-lee-pc
  cancel-in-progress: true

env:
  WORK_DIR: "C:\\Users\\82108\\Desktop\\ì—…ë¬´ìë™í™”"
  CHROME_PATH: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
  PROFILE_PATH: "C:\\chrometemp"
  DEBUG_PORT: "9222"

jobs:
  run-gfa:
    runs-on: [self-hosted, windows, x64]
    timeout-minutes: 30

    steps:
      - name: 1) ì‚¬ì „ ì ê²€
        shell: cmd
        run: |
          chcp 65001
          if not exist "${{ env.WORK_DIR }}" (echo âŒ WORK_DIR ì—†ìŒ && exit /b 1)
          if not exist "${{ env.CHROME_PATH }}" (echo âŒ CHROME_PATH ì—†ìŒ && exit /b 1)
          where python || (echo âŒ python ì—†ìŒ && exit /b 1)
          if not exist "${{ env.PROFILE_PATH }}" mkdir "${{ env.PROFILE_PATH }}"

      - name: 2) ë´‡ í¬ë¡¬ ì •ë°€ ì¢…ë£Œ + ì ê¸ˆíŒŒì¼ ì œê±°
        shell: cmd
        run: |
          chcp 65001
          echo ğŸ§¹ chrometemp ì‚¬ìš©í•˜ëŠ” í¬ë¡¬ë§Œ ì¢…ë£Œ...
          powershell -NoProfile -Command "Get-CimInstance Win32_Process | Where-Object { $_.Name -eq 'chrome.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"

          echo ğŸ”“ Singleton* ì œê±°...
          del /f /q "${{ env.PROFILE_PATH }}\SingletonLock" 2>nul
          del /f /q "${{ env.PROFILE_PATH }}\SingletonCookie" 2>nul
          del /f /q "${{ env.PROFILE_PATH }}\SingletonSocket" 2>nul

      - name: 3) í¬ë¡¬ ì‹¤í–‰ (ì›ê²©ë””ë²„ê¹…)
        shell: cmd
        run: |
          chcp 65001
          echo ğŸŒ Chrome start...
          start "" "${{ env.CHROME_PATH }}" ^
            --remote-allow-origins=* ^
            --remote-debugging-port=${{ env.DEBUG_PORT }} ^
            --remote-debugging-address=127.0.0.1 ^
            --user-data-dir="${{ env.PROFILE_PATH }}" ^
            --disable-gpu ^
            --disable-dev-shm-usage ^
            --disable-session-crashed-bubble ^
            --hide-crash-restore-bubble ^
            --no-first-run ^
            --no-default-browser-check ^
            --window-size=1920,1080

      - name: 4) DevTools ì‘ë‹µ í™•ì¸ (json/version)
        shell: cmd
        run: |
          chcp 65001
          echo â³ DevTools ready check (ìµœëŒ€ 60ì´ˆ)...
          set /a TRY=0
          :RETRY
          set /a TRY+=1
          powershell -NoProfile -Command "try { $r = Invoke-WebRequest -UseBasicParsing http://127.0.0.1:${{ env.DEBUG_PORT }}/json/version -TimeoutSec 2; if($r.StatusCode -eq 200){ exit 0 } else { exit 1 } } catch { exit 1 }"
          if %ERRORLEVEL%==0 (
            echo âœ… DevTools OK
            powershell -NoProfile -Command "Invoke-WebRequest -UseBasicParsing http://127.0.0.1:${{ env.DEBUG_PORT }}/json/version -TimeoutSec 2 | Select-Object -Expand Content"
            goto :OK
          )
          if %TRY% GEQ 12 (echo âŒ DevTools not ready && exit /b 1)
          echo ...retry (%TRY%/12)
          ping 127.0.0.1 -n 6 > nul
          goto :RETRY
          :OK

      - name: 5) GFA ìˆ˜ì§‘ ì‹¤í–‰
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          chcp 65001
          set "PYTHONIOENCODING=utf-8"
          set "PYTHONUTF8=1"
          python gfa_bot_final.py

      - name: 6) êµ¬ê¸€ ì‹œíŠ¸ ì—…ë¡œë“œ ì‹¤í–‰
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          chcp 65001
          set "PYTHONIOENCODING=utf-8"
          set "PYTHONUTF8=1"
          python gfa_to_sheet.py

      - name: 7) ì¢…ë£Œ ì²˜ë¦¬ (í•­ìƒ)
        if: always()
        shell: cmd
        run: |
          chcp 65001
          echo ğŸ§¹ ë´‡ í¬ë¡¬ ì¢…ë£Œ...
          powershell -NoProfile -Command "Get-CimInstance Win32_Process | Where-Object { $_.Name -eq 'chrome.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"
