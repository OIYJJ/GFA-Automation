name: GFA Marketing Bot (Lee's PC)

on:
  schedule:
    - cron: '30 20 * * *' # 05:30 KST (ìƒˆë²½ ë©”ì¸)
    - cron: '0 4 * * *'   # 13:00 KST (ì ì‹¬ ì—°ì¥)
    - cron: '20 6 * * *'  # 15:20 KST (ì˜¤í›„ ì—°ì¥)
  workflow_dispatch:
    inputs:
      force_main_run:
        description: "ìˆ˜ë™ ì‹¤í–‰ ì‹œ MAIN_RUN ê°•ì œ(true/false). ë¹„ìš°ë©´ schedule ê¸°ì¤€ ìë™ ê²°ì •"
        required: false
        default: ""

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ (ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ê³¼ ì¶©ëŒ ë°©ì§€)
concurrency:
  group: gfa-marketing-bot-lee-pc
  cancel-in-progress: true

env:
  WORK_DIR: "C:\\Users\\82108\\Desktop\\ì—…ë¬´ìë™í™”"
  CHROME_PATH: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"
  PROFILE_PATH: "C:\\chrometemp"
  DEBUG_PORT: "9222"

jobs:
  run-local-marketing-bot:
    runs-on: [self-hosted, windows, x64]
    timeout-minutes: 30

    steps:
      - name: 1) ì‹œê°„ëŒ€ ë° ì‹¤í–‰ ëª¨ë“œ ì„¤ì •
        shell: cmd
        run: |
          chcp 65001
          set "FORCE_MAIN=${{ github.event.inputs.force_main_run }}"
          set "SCHEDULE=${{ github.event.schedule }}"

          if not "%FORCE_MAIN%"=="" (
            if /I "%FORCE_MAIN%"=="true" (
              echo ğŸŒ™ [ìˆ˜ë™-ê°•ì œ] MAIN_RUN=true
              echo MAIN_RUN=true>> "%GITHUB_ENV%"
              goto :EOF
            )
            if /I "%FORCE_MAIN%"=="false" (
              echo â˜€ï¸ [ìˆ˜ë™-ê°•ì œ] MAIN_RUN=false
              echo MAIN_RUN=false>> "%GITHUB_ENV%"
              goto :EOF
            )
          )

          if "%SCHEDULE%"=="30 20 * * *" (
            echo ğŸŒ™ [ìƒˆë²½ ëª¨ë“œ] ë©”ì¸ ìˆ˜ì§‘ + ì—…ë¡œë“œ í™œì„±í™”
            echo MAIN_RUN=true>> "%GITHUB_ENV%"
          ) else (
            echo â˜€ï¸ [ì—…ë¬´ ëª¨ë“œ] ì„¸ì…˜ ì—°ì¥ ëª¨ë“œ
            echo MAIN_RUN=false>> "%GITHUB_ENV%"
          )

      - name: 2) ì‚¬ì „ ì ê²€ (ê²½ë¡œ ë° íŒŒì´ì¬)
        shell: cmd
        run: |
          chcp 65001
          if not exist "${{ env.WORK_DIR }}" (echo âŒ WORK_DIR ì—†ìŒ && exit /b 1)
          if not exist "${{ env.CHROME_PATH }}" (echo âŒ CHROME_PATH ì—†ìŒ && exit /b 1)
          where python || (echo âŒ python ì—†ìŒ && exit /b 1)

      - name: 3) í¬ë¡¬ í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬ ì¢…ë£Œ ë° ì„¤ì • íŒ¨ì¹˜ (íŒì—… ì°¨ë‹¨)
        shell: cmd
        run: |
          chcp 65001
          echo ğŸ§¹ ë´‡ ì „ìš© í¬ë¡¬(chrometemp)ë§Œ ì •ë°€ ì¢…ë£Œ...
          powershell -NoProfile -Command "Get-CimInstance Win32_Process | Where-Object { $_.Name -eq 'chrome.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"
          
          echo ğŸ”“ í”„ë¡œí•„ ì ê¸ˆ(Singleton*) ë° ì„ì‹œ íŒŒì¼ ì •ë¦¬...
          if exist "${{ env.PROFILE_PATH }}\SingletonLock" del /f /q "${{ env.PROFILE_PATH }}\SingletonLock"
          if exist "${{ env.PROFILE_PATH }}\SingletonCookie" del /f /q "${{ env.PROFILE_PATH }}\SingletonCookie"
          
          echo ğŸ› ï¸ [ì¤‘ìš”] ë¹„ì •ìƒ ì¢…ë£Œ ê¸°ë¡ ì„¸íƒ (ë³µêµ¬ íŒì—… ì›ì²œ ì°¨ë‹¨)...
          set "PREF_FILE=${{ env.PROFILE_PATH }}\Default\Preferences"
          if exist "%PREF_FILE%" (
            powershell -NoProfile -Command "$p='%PREF_FILE%'; $t=Get-Content $p -Raw; if($t -match 'exit_type\":\"Crashed'){ $t2=$t -replace 'exit_type\":\"Crashed','exit_type\":\"Normal'; Set-Content $p $t2 -Encoding UTF8; echo 'âœ… Preferences Patched' }else{ echo 'â„¹ï¸ Already Normal' }"
          )

      - name: 4) í¬ë¡¬ ì‹¤í–‰ ë° í¬íŠ¸ í†µì‹  ê²€ì¦ (TCP Check)
        shell: cmd
        run: |
          chcp 65001
          echo ğŸŒ ë´‡ í¬ë¡¬ ì‹¤í–‰ (ë³´ì•ˆ/í†µì‹  ì˜µì…˜ ê°•í™”)...
          start "" "${{ env.CHROME_PATH }}" ^
            --remote-allow-origins=* ^
            --remote-debugging-port=${{ env.DEBUG_PORT }} ^
            --remote-debugging-address=127.0.0.1 ^
            --user-data-dir="${{ env.PROFILE_PATH }}" ^
            --disable-gpu ^
            --disable-dev-shm-usage ^
            --disable-session-crashed-bubble ^
            --hide-crash-restore-bubble ^
            --no-first-run ^
            --window-size=1920,1080

          echo â³ í¬íŠ¸ ì˜¤í”ˆ ê²€ì¦ ì‹œì‘ (ìµœëŒ€ 60ì´ˆ)...
          set /a TRY=0
          :RETRY_PORT
          set /a TRY+=1
          powershell -NoProfile -Command "if ((Test-NetConnection 127.0.0.1 -Port ${{ env.DEBUG_PORT }}).TcpTestSucceeded) { exit 0 } else { exit 1 }"
          if %ERRORLEVEL%==0 (echo âœ… í¬íŠ¸ %DEBUG_PORT% í™œì„±í™” í™•ì¸! && goto :PORT_OK)
          if %TRY% GEQ 12 (echo âŒ í¬íŠ¸ ì‘ë‹µ ì—†ìŒ && exit /b 1)
          echo ...ëŒ€ê¸° ì¤‘ (%TRY%/12)
          ping 127.0.0.1 -n 6 > nul
          goto :RETRY_PORT
          :PORT_OK

      - name: 5) GFA ë°ì´í„° ìˆ˜ì§‘ ì‹¤í–‰
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          set "PYTHONIOENCODING=utf-8"
          set "PYTHONUTF8=1"
          python gfa_bot_final.py

      - name: 6) [ìƒˆë²½/ìˆ˜ë™ MAIN ì „ìš©] êµ¬ê¸€ ì‹œíŠ¸ ì—…ë¡œë“œ
        if: env.MAIN_RUN == 'true'
        shell: cmd
        working-directory: ${{ env.WORK_DIR }}
        run: |
          set "PYTHONIOENCODING=utf-8"
          python gfa_to_sheet.py

      - name: 7) ì‘ì—… ì™„ë£Œ ì²˜ë¦¬ (í•­ìƒ ì‹¤í–‰)
        if: always()
        shell: cmd
        run: |
          chcp 65001
          if "%MAIN_RUN%"=="true" (
            echo ğŸŒ™ [ìƒˆë²½] ìˆ˜ì§‘ ì™„ë£Œ. ë´‡ í¬ë¡¬ ì •ë°€ ì¢…ë£Œ.
            powershell -NoProfile -Command "Get-CimInstance Win32_Process | Where-Object { $_.Name -eq 'chrome.exe' -and $_.CommandLine -like '*chrometemp*' } | Stop-Process -Force -ErrorAction SilentlyContinue"
          ) else (
            echo â˜€ï¸ [ì—…ë¬´] ì„¸ì…˜ ì—°ì¥ ì™„ë£Œ. ë¸Œë¼ìš°ì € ìœ ì§€.
          )
